# reading data and converting them to dataframes R 
data <- read.csv("/Users/markadut/Desktop/2019_groceries.csv")
geo_data = read.csv("/Users/markadut/Downloads/Main_US_GroceryStores_Aug2019-GEOMETRY-2019-08-30/Main_US_GroceryStores_Aug2019-GEOMETRY-2019-08-30.csv")
  
zip <- max(data$zip_code)

retval <- subset(data, zip_code == max(zip_code))
print(retval)

brand <- subset(data, (brands == "Whole Foods Market" & city == "los angeles")) #data shows whole foods markets data in la
print.data.frame(brand)

# downloading all necessary libraries and packages
library(sf)
library(maptools)
library(raster)
library(spatstat)

install.packages(c("cowplot", "googleway", "ggplot2", "ggrepel", "ggspatial", "libwgeom", "sf", "rnaturalearth", "rnaturalearthdata"))

library("ggplot2")
theme_set(theme_bw())

library("rnaturalearth")
library("rnaturalearthdata")

x <- geo_data[, 3] #extracting longitude data from grocery store df
y <- geo_data[, 2] #extracting latitude data from grocery store df
xy_df <- data.frame(x, y)

x_pop_density = combined_states[, 1]
y_pop_density = combined_states[, 2]
xy_density_dataset = data.frame(x_pop_density, y_pop_density)
  
#convert grocery store x y coordinates into a separate dataframe consisting of only 
#longs and lats

world <- ne_countries(scale = "medium", returnclass = "sf")
class(world)
#plot(x,y, pch=19)


#start visualizing the grocery store data on the USA continental map
p <- ggplot(data = world) +
    geom_sf() +
     geom_point(data = xy_df, aes(x = x, y = y), size = 0.5, 
             shape = 23, fill = "darkred") +
  coord_sf(xlim = c(-128, -66), ylim = c(24, 50), expand = FALSE)

plot(p)

library(maptools)
library(spatstat)

# creating raster obejcts for the us state pop density .tif files
img <- raster("/Users/markadut/Downloads/50_US_states_1km_2019_PD_UNadj/states_density_tiff/US-CA_pd_2019_1km_UNadj.tif")
pop  <- as.im(img)
#plot(img)
california_csv = read.csv("/Users/markadut/Desktop/50_states_pop_density/US-CA_pd_2019_1km_UNadj_ASCII_XYZ.csv")

# merge the Geo data and grocery data
merged_grocery_data <- merge(data,geo_data,by="safegraph_place_id")
california_grocery_stores <- subset(merged_grocery_data, (state == "ca"))
california_polygon_data <- merged_grocery_data[, 17]
california_polygon_dataframe <- data.frame(california_polygon_data)
california_longs =  california_grocery_stores[, 16]
california_lats =  california_grocery_stores[, 15]
california_xy = data.frame(california_longs, california_lats)

# plotting grocery stores in only California

california_groceries <- ggplot(data = world) +
  geom_sf() +
  geom_point(data = california_xy, aes(x = california_longs, y = california_lats), size = 0.5, 
             shape = 23, fill = "darkred") +
  coord_sf(xlim = c(-125, -115), ylim = c(32, 42), expand = FALSE)

print(california_groceries)

hist(pop, main=NULL, las=1)# pop density raster layer historgram
pop.lg <- log(pop)
hist(pop.lg, main=NULL, las=1)

library(maptools)
library(rgdal)
library(spatstat)

setwd("/Users/markadut/Desktop/DATA 1150 FELLOW/CA_Boundary_Projected") # Replace the file path with the actual location of your shapefiles.

#plotting the California shape file border
s  <- readOGR("/Users/markadut/Desktop/DATA 1150 FELLOW/CA_Boundary_Projected")
s.sf <- as(s, "sf")
s.sf.utm <- st_transform(s.sf, 32619) # project from geographic to UTM
ca <- as.owin(s.sf.utm)
plot(ca)

# Set working directory to the californian_grocery_stores_file
setwd("/Users/markadut/Downloads/california_grocery_stores") # Replace the file path with the actual location of your shapefiles.

#reading California_grocery_stores shapefile - got from ArcGIS
c  <- readOGR("/Users/markadut/Downloads/california_grocery_stores")  # Don't add the .shp extension

#creating .ppp object for California grocery stores

p.sf  <- as(c, "sf")      # Create Spatial* object
st_crs(p.sf)
p.sf.utm <- st_transform(p.sf, 32619) # project from geographic to UTM
p.sp  <- as(p.sf.utm, "Spatial")      # Create Spatial* object
groceries <- as(p.sp, "ppp")             # Create .ppp object
class(groceries) 

marks(groceries)  <- NULL
Window(groceries) <- ca

Q <- quadratcount(groceries, nx= 6, ny=6) 
plot(groceries, main=NULL, cols="grey70",pch=20) # add quadrant grid
plot(Q, add = TRUE) 

# Compute the density for each quadrat
Q.d <- intensity(Q)
# Plot the density
plot(intensity(Q, image=TRUE), main=NULL, las=1)  # Plot density raster
plot(starbucks, pch=20, cex=0.6, col=rgb(0,0,0,.5), add=TRUE)  # Add points


# scaling the groceries data shape as well as the Cali shapefile and the population density layer
groceries.km <- rescale(groceries, 1000, "km")
ca.km <- rescale(ca, 1000, "km")
pop.km  <- rescale(pop, 1000, "km")
pop.lg.km <- rescale(pop.lg, 1000, "km")

# Compute the density for each quadrat (in counts per km2)
Q  <- quadratcount(groceries.km, nx= 6, ny=6)
Q.d <- intensity(Q)

# Plot the density
plot(intensity(Q, image=TRUE), main=NULL, las=1)  # Plot density raster
plot(groceries.km, pch=20, cex=0.6, col=rgb(0,0,0,.5), add=TRUE)  # Add points
